name: Build Windows EXE

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install requirements
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Download static Windows FFmpeg (static build)
        run: |
          mkdir -p ffmpeg
          powershell -Command "Invoke-WebRequest -Uri 'https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip' -OutFile 'ffmpeg.zip'"
          powershell -Command "Expand-Archive -Path ffmpeg.zip -DestinationPath ffmpeg_tmp"
          powershell -Command "Copy-Item -Path (Get-ChildItem -Path ffmpeg_tmp -Recurse -Filter ffmpeg.exe | Select-Object -First 1).FullName -Destination ffmpeg\\ffmpeg.exe"

      - name: Build single EXE with PyInstaller
        run: |
          mkdir -p dist
          pyinstaller --noconfirm --onefile --windowed \
            --add-data "ffmpeg\\ffmpeg.exe;ffmpeg" \
            src/app_windows.py \
            --name CCTV_Streamer

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: CCTV_Streamer_exe
          path: dist\\CCTV_Streamer.exe
